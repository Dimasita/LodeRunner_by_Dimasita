const WebSocket = require('ws')
const wsServer = new WebSocket.Server( { port: 3000 } )
let board1 = 'board=☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼' +
             '      (    ►                 ~~~~~~~~~     &     ~~~~~~~☼☼##H########################H#H' +
             ' &    $H##########H       ☼☼  H         &  &&      &@  H######H (H        & H#☼☼☼☼☼#☼☼' +
             'H☼☼#☼☼H &  H#########H   ( H#   $ H#####H#####H##&$~~~~~☼☼H     H    H   & && &H#####H#  ' +
             '   H ~   H   &@H  ~~(((((☼☼H#☼#☼#H    H         H  ~~~&#####H#     H     H   $ЄЄ(((☼☼H@@~' +
             '  H~~~~H~~~~~~   H        $  H$  H######H##    & ЄЄ(☼☼H     H& & H   $ H###☼☼☼☼☼☼H☼   &' +
             'H~~~H    $ H( (     & #☼☼H     H    Q#####H     (  (H     H      H#########H     ☼☼☼###☼#' +
             '#☼##☼H @& &  $ H###H##    H##     H#       ## ( ( ☼☼☼###☼~~~~& H         H $&H######H#####' +
             '#### H###H #####H#☼☼☼(((☼  &   H   ~~~~~ЄH   H      H          H#@#H      H$☼☼########H###' +
             '☼☼☼☼     H  ############   ######&##########☼☼        H           »Q       (  ($&         ' +
             '      (  (  ☼☼H##########################H########Є~~####H############☼☼H                 ~' +
             '~~ @$$  H              $H           &☼☼#######H#######  $@ @      H###~~~~     &############' +
             'H &☼☼&  $&  H~~~~~~~~~~   (    »H                         H  ☼☼    &  H    ##H   #######Q####' +
             '######~~~~~~~H######## H  ☼☼       H    ##H          H                 H   &&&   H  ☼☼##H#####' +
             '    ########H#######~~~~  ~~~#########~~~~~  H  ☼☼  H                 H  & @$           &      ' +
             '   $~~~~H  ☼☼#########H##########H  $ @   #☼☼☼☼☼☼#   ☼☼☼☼☼☼☼    $ H  ☼☼(  &&&&  H   $$   ' +
             '  H        ~(( (((~            (   H  ☼☼☼☼       H~~~~~~~~~~H        &######   ###########   H' +
             ' (☼☼    H###### $$&@ &  #######H    (      ~~~~~~~~~~~~~ЄH (☼☼H☼  H   (                  H ' +
             ' H####H     »(          H (☼☼H☼☼#☼☼☼☼☼☼☼☼☼☼☼☼###☼☼☼☼☼☼☼☼H☼☼☼☼☼☼☼☼#☼☼☼☼☼☼☼☼☼☼☼☼' +
             '☼☼☼☼☼☼#☼☼H @  &       ~~H~~~~☼☼☼☼☼☼☼H☼☼☼☼☼☼☼       H   ~~~~~~~~~H☼☼H~~~~  ######  H  ' +
             '      $H☼H☼H        ####H (☼       & H☼☼H        &     ##H#######H☼H☼H######H &  $###☼☼☼☼☼☼' +
             '☼☼ ~H☼☼H#########      (H    ~~~H☼H☼H~~~   H~~~~~&##(((((   ~ Q☼☼H && @  &###H## #H##H     ☼' +
             'H☼@      H     ###☼☼☼☼☼☼ ~  H☼☼H        & &H   & &#######☼H☼#####  H##### & ~~~~~~~ ~ H☼☼~~~' +
             '~~~~~~~~~H       H~~~~~☼H☼~~~~~  H       (  &&&~ ~  H☼☼ $   H              H((  (☼H☼     #####' +
             '#####H (    (   Q☼☼ ### #############H H#####☼H☼   (       &   H ######## H☼☼H      & & $     ' +
             ' H $   $$☼H☼####### &     (H          H☼☼H##### (   (  (H##H####      (         ###H######### ' +
             '  H☼☼H   &  H######### H $ ############    «&  H            H☼☼H##    H    &     H~~~~~~     ' +
             '            H #######H## H☼☼~~~~#####H#   ~~ЄЄH         ########H     H  &&$   H   H☼☼        ' +
             ' H        H      ~~~~~~~~   H     H        H   H☼☼   ########H    ######H##   @    ##########' +
             '####    H   H☼☼           H          H        ~Є~~~        $$ ##H#####H☼☼H    ###########H     ' +
             'H#####H         H##H    &  H &   H☼☼H###            H     H     ###########$&##H###  H  (  H☼' +
             '☼H  ######  ##H######  H                    H &$##H###  H☼☼H            H ~~~~~##H###H     ####' +
             '#####H##        $  H☼☼    H########H#       H&  ######@        H  ((     &$  H☼☼ ###H        ' +
             'H         ~~~~~H  &   ##H###H####H###     H☼☼    H########H######### &&  H        H &@     H' +
             '        H☼☼H   H      @                Q(    (  H        H   (   @H☼☼H  ####H######         ' +
             '#####H########H##      H#####   H☼☼H      H      H#######H        (              H     (  H☼☼#' +
             '#############H       H#################################☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼' +
             '☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼'

let board = 'board=☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼' +
    '☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼                    $  $     ' +
    '~~~~~~~~~     @     ~~~~~~~☼☼##H########################H#H &    $H##########H       ' +
    '☼☼$ H         ' +
    '      (        H######H& H          H#☼☼☼☼☼#☼☼H☼☼#☼☼H   @H#########H     H#     H##' +
    '###H#####H##  ' +
    '~~~~~☼☼H&  & H    H         H#####H#     H ~   H  &  H  ~~ $  $☼☼H#☼#☼#H    H       &' +
    ' H& ~~~ ' +
    '#####H#@ $  H   @ H    ~~   ☼☼H  ~ $H~~~~H~~~~~~   H   @     @ H   H######H##      ~~ ' +
    '☼☼H     H    ' +
    'H$    H###☼☼☼☼☼☼H☼    H~~~H      H     &    #☼☼H     H    H#####H         H  $& H   ' +
    '   H#########H ' +
    '    ☼☼H###☼##☼##☼H         H###H##    H##  $  H# $   &$##   @ ☼☼H###☼~~~~ &H       ' +
    '  H   ' +
    'H######H######### H###H #####H#☼☼H     $    H   ~~~~~~H   H     &H          H# #H      ' +
    'H ' +
    '☼☼########H###☼☼☼☼     H$ ############   ###### ##########☼☼       @H            H  ' +
    '      $        ' +
    '           $  &  ☼☼H##########################H########Є~~####H############☼☼H       ' +
    '          ~~~ ' +
    '     H  $            H    &       ☼☼#######H####### &         «H###~~~~      ##########' +
    '##H  ☼☼  @  ' +
    '  H~~~~~~~~~~  $ ((   H«    &           (       H  ☼☼     &&H    ##H   ' +
    '#######H##########~~~~~~~H######## H  ☼☼   (   H    ##H          H        &&   & $ H  ' +
    '       H ' +
    '&☼☼##H#####  & ########H#######~~~~  ~~~#########~~~~~  H  ☼☼  H            &    H   ' +
    '           ( ' +
    '&$  &       ~~~~H  ☼☼#########H##########H      &&#☼☼☼☼☼☼#   ☼☼☼☼☼☼☼      H  ☼☼ ' +
    '   &    H         ' +
    '&H   $    ~      ~                H  ☼☼☼☼   (   H~~~~~~~~~~H      (« ######   ######' +
    '#####   H&&☼☼ ' +
    '@  H######  &   $  #######H         & ~~~~~~~~~~~~~~H  ☼☼H☼  H          &      @    H&' +
    ' H####H      ' +
    '   @       H  ☼☼H☼☼#☼☼☼☼☼☼☼☼☼☼☼☼###☼☼☼☼☼☼☼☼H☼☼☼☼☼☼☼☼#☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼' +
    '☼☼#☼☼H           (' +
    '~~H~~~~☼☼☼☼☼☼☼H☼☼☼☼☼☼☼       H   ~~~~~~~~~H☼☼H~~~~  ######  H         H☼H☼H&     ' +
    '  ####H  ☼        ' +
    '&H☼☼H        &     ##H#######H☼H☼H######H &   ###☼☼☼☼☼☼☼☼ ~H☼☼H#########  &    H ' +
    '$  ~~~H☼H☼H~~~   ' +
    'H~~~~~ ##   (    ~ H☼☼H        ###H####H##H&    ☼H☼       H     ###☼☼☼☼☼☼ ~  H☼☼H' +
    '           H      ' +
    '#######☼H☼#####  H#####$  ~~~~~~~ ~&H☼☼~~~~~~~~~~~~H       H~~~~~☼H☼~~~~~  H        ' +
    '     ~ ~  H☼☼  ' +
    '   H  &         & H    $☼H☼$    ##########H  @    @  H☼☼ ### #############H H#####☼H' +
    '☼              ' +
    ' H ######## H☼☼H$  ( $        & (H    $  ☼H☼#######        H          H☼☼H#####      ' +
    ' & H##H####&& ' +
    '             ###H#########   H☼☼H$     H######### H  &############ &$&@   H           ' +
    ' H☼☼H##    H ' +
    '         H~~~~~~        »        H #######H## H☼☼~~~~#####H#   ~~~~H  &      ########H' +
    '    &H      ' +
    '& H   H☼☼ $$   &  H   @    H      ~~~~~~~~   H@ &(&H&  &    H   H☼☼   ########H    ##' +
    '####H##       ' +
    ' ##############    H (&H☼☼        &  H          H    &  &~~~~~$        &&##H#####H☼☼H    ' +
    '###########H     H#####H         H##H      &H     H☼☼H###   »        H     H  @  #####' +
    '###### ' +
    '&##H###& H     H☼☼H @######  ##H######  H   $                H   ##H###  H☼☼H            H ' +
    '~~~~~##H###H    )#########H##           H☼☼    H########H# $     H   ######       ► H  ' +
    '           ' +
    'H☼☼ ###H     $ &H $   @   ~~~~~H      ##H###H####H###     H☼☼   &H########H#########    ' +
    '&H        ' +
    'H        H        H☼☼H   H  &&              &    H&       H   $    H   (    H☼☼H  ####' +
    'H######     ' +
    '&   #####H########H##      H#####   H☼☼H      H      H#######H        &    &         H' +
    '    &   ' +
    'H☼☼##############H       ' +
    'H#################################☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼' +
    '☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼ '

let board2 = 'board=☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼                    $  $     ~~~~~~~~~     @     ~~~~~~~☼☼##H########################H#H &    $H##########H       ☼☼$ H                        H######H& H          H#☼☼☼☼☼#☼☼H☼☼#☼☼H   @H#########H     H#     H#####H#####H##  ~~~~~☼☼H&  & H    H         H#####H#     H ~   H  &  H  ~~ $  $☼☼H#☼#☼#H    H       & H& ~~~ #####H#@ $  H   @ H    ~~   ☼☼H  ~ $H~~~~H~~~~~~   H   @     @ H   H######H##      ~~ ☼☼H     H    H$    H###☼☼☼☼☼☼H☼    H~~~H      H     &    #☼☼H     H    H#####H         H  $& H      H#########H     ☼☼H###☼##☼##☼H         H###H##    H##  $  H# $   &$##   @ ☼☼H###☼~~~~ &H         H   H######H######### H###H #####H#☼☼H     $    H   ~~~~~~H   H     &H          H# #H      H ☼☼########H###☼☼☼☼     H$ ############   ###### ##########☼☼       @H            H        $                   $  &  ☼☼H##########################H########~~~####H############☼☼H                 ~~~      H  $            H    &       ☼☼#######H####### &          H###~~~~      ############H  ☼☼  @    H~~~~~~~~~~  $      H     &                   H  ☼☼     &&H    ##H   #######H##########~~~~~~~H######## H  ☼☼       H    ##H          H        &&   & $ H         H &☼☼##H#####  & ########H#######~~~~  ~~~#########~~~~~  H  ☼☼  H            &    H                &$  &       ~~~~H  ☼☼#########H##########H      &&#☼☼☼☼☼☼#   ☼☼☼☼☼☼☼      H  ☼☼    &    H         &H   $    ~      ~                H  ☼☼☼☼       H~~~~~~~~~~H         ######   ###########   H&&☼☼ @  H######  &   $  #######H         & ~~~~~~~~~~~~~~H  ☼☼H☼  H          &      @    H& H####H         @       H  ☼☼H☼☼#☼☼☼☼☼☼☼☼☼☼☼☼###☼☼☼☼☼☼☼☼H☼☼☼☼☼☼☼☼#☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼#☼☼H            ~~H~~~~☼☼☼☼☼☼☼H☼☼☼☼☼☼☼       H   ~~~~~~~~~H☼☼H~~~~  ######  H         H☼H☼H&       ####H  ☼        &H☼☼H        &     ##H#######H☼H☼H######H &   ###☼☼☼☼☼☼☼☼ ~H☼☼H#########  &    H $  ~~~H☼H☼H~~~   H~~~~~ ##        ~ H☼☼H        ###H####H##H&    ☼H☼       H     ###☼☼☼☼☼☼ ~  H☼☼H           H      #######☼H☼#####  H#####$  ~~~~~~~ ~&H☼☼~~~~~~~~~~~~H       H~~~~~☼H☼~~~~~  H             ~ ~  H☼☼     H  & ►       & H    $☼H☼$    ##########H  @    @  H☼☼ ### #############H H#####☼H☼               H ######## H☼☼H$    $        &  H    $  ☼H☼#######        H          H☼☼H#####       & H##H####&&              ###H#########   H☼☼H$     H######### H  &############ &$&@   H            H☼☼H##    H          H~~~~~~                 H #######H## H☼☼~~~~#####H#   ~~~~H  &      ########H    &H      & H   H☼☼ $$   &  H   @    H      ~~~~~~~~   H@ & &H&  &    H   H☼☼   ########H    ######H##        ##############    H  &H☼☼        &  H          H    &  &~~~~~$        &&##H#####H☼☼H    ###########H     H#####H         H##H      &H     H☼☼H###            H     H  @  ########### &##H###& H     H☼☼H @######  ##H######  H   $                H   ##H###  H☼☼H            H ~~~~~##H###H     #########H##           H☼☼    H########H# $     H   ######         H             H☼☼ ###H     $ &H $   @   ~~~~~H      ##H###H####H###     H☼☼   &H########H#########    &H        H        H        H☼☼H   H  &&              &    H&       H   $    H        H☼☼H  ####H######     &   #####H########H##      H#####   H☼☼H      H      H#######H        &    &         H    &   H☼☼##############H       H#################################☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼☼'
let clients = []
let current_block_type = ' '
let start_time = 0

wsServer.on('connection', (wsClient) => {
    console.log('Новый пользователь')
    wsClient.send(board2)
    clients.push(wsClient)

    wsClient.on('message', function(message) {
        let end_time = new Date().getTime()
        let time = end_time - start_time
        console.log('Took ' + time + ' ms')

        let ind = board2.indexOf('►')
        if ((board2[ind + 58] === ' ' || board2[ind + 58] === '$' ||
            board2[ind + 58] === '@' || board2[ind + 58] === '&')
            && current_block_type === ' ') {
                board2 = replaceAt(board2, ind, current_block_type)
                current_block_type = board2[ind + 58]
                board2 = replaceAt(board2, ind + 58, '►')
        }
        else {
            switch (message) {
                case 'left':
                    board2 = replaceAt(board2, ind, current_block_type)
                    current_block_type = board2[ind - 1]
                    board2 = replaceAt(board2, ind - 1, '►')
                    break

                case 'right':
                    board2 = replaceAt(board2, ind, current_block_type)
                    current_block_type = board2[ind + 1]
                    board2 = replaceAt(board2, ind + 1, '►')
                    break

                case 'down':
                    board2 = replaceAt(board2, ind, current_block_type)
                    current_block_type = board2[ind + 58]
                    board2 = replaceAt(board2, ind + 58, '►')
                    break

                case 'up':
                    board2 = replaceAt(board2, ind, current_block_type)
                    current_block_type = board2[ind - 58]
                    board2 = replaceAt(board2, ind - 58, '►')
                    break

                case 'act,left':
                    if (board2[ind + 57] === '#') {
                        board2 = replaceAt(board2, ind + 57, ' ')
                        setTimeout(() => {
                            board2 = replaceAt(board2, ind + 57, '#')
                        }, 6000)
                    }
                    break

                case 'act,right':
                    if (board2[ind + 59] === '#') {
                        board2 = replaceAt(board2, ind + 59, ' ')
                        setTimeout(() => {
                            board2 = replaceAt(board2, ind + 59, '#')
                        }, 6000)
                    }
                    break

                default: break
            }
        }
        if (current_block_type === '&' || current_block_type === '@' || current_block_type === '$')
            current_block_type = ' '

        send_board()
    })
})

function send_board() {
    for (let i = 0; i < clients.length; i++) {
        clients[i].send(board2)
    }
    start_time = new Date().getTime()
}

// setInterval(send_board, 2000)


function replaceAt(string, index, replace) {
  return string.substring(0, index) + replace + string.substring(index + 1);
}